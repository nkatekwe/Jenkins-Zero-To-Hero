pipeline {
    agent any
    
    environment {
        IMAGE_TAG = "${BUILD_NUMBER}"
        DOCKER_REGISTRY = "abhishekf5"
        APP_NAME = "cicd-e2e"
        MANIFESTS_REPO = "https://github.com/iam-veeramalla/cicd-demo-manifests-repo.git"
        SOURCE_REPO = "https://github.com/iam-veeramalla/cicd-end-to-end.git"
        CREDENTIALS_ID = 'f87a34a8-0e09-45e7-b9cf-6dc68feac670'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        stage('Checkout Source') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'main']],
                    extensions: [],
                    userRemoteConfigs: [[
                        url: SOURCE_REPO,
                        credentialsId: CREDENTIALS_ID
                    ]]
                ])
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    docker.build("${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}")
                }
            }
        }
        
        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('', 'docker-credentials') {
                        docker.image("${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}").push()
                    }
                }
            }
        }
        
        stage('Checkout & Update Manifests') {
            steps {
                dir('manifests') {
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: 'main']],
                        extensions: [],
                        userRemoteConfigs: [[
                            url: MANIFESTS_REPO,
                            credentialsId: CREDENTIALS_ID
                        ]]
                    ])
                    
                    withCredentials([usernamePassword(
                        credentialsId: CREDENTIALS_ID,
                        usernameVariable: 'GIT_USERNAME',
                        passwordVariable: 'GIT_PASSWORD'
                    )]) {
                        sh '''
                            echo "Updating deploy.yaml with image tag: ${IMAGE_TAG}"
                            
                            # Backup original file
                            cp deploy.yaml deploy.yaml.backup
                            
                            # Update image tag
                            sed -i "s|abhishekf5/cicd-e2e:[0-9]*|abhishekf5/cicd-e2e:${IMAGE_TAG}|g" deploy.yaml
                            
                            # Verify changes
                            echo "=== Updated deploy.yaml ==="
                            grep -n "image:" deploy.yaml
                            
                            # Commit and push
                            git config user.email "jenkins@example.com"
                            git config user.name "Jenkins CI"
                            git add deploy.yaml
                            git commit -m "CI: Update image tag to ${IMAGE_TAG}"
                            git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/iam-veeramalla/cicd-demo-manifests-repo.git HEAD:main
                        '''
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                dir('manifests') {
                    sh '''
                        echo "Applying Kubernetes manifests..."
                        kubectl apply -f deploy.yaml
                        kubectl rollout status deployment/cicd-e2e
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo "Pipeline completed successfully!"
            emailext(
                subject: "Pipeline Success: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "Build ${env.BUILD_NUMBER} completed successfully.",
                to: 'team@example.com'
            )
        }
        failure {
            echo "Pipeline failed!"
        }
        cleanup {
            cleanWs()
        }
    }
}
